const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BPHe3uFU.js","assets/react-vendor-KfUPlHYY.js","assets/mermaid-CKqTDO4C.js","assets/index-qzTNV2SH.css"])))=>i.map(i=>d[i]);
import{_ as l}from"./mermaid-CKqTDO4C.js";import{d as y}from"./index-BPHe3uFU.js";import"./react-vendor-KfUPlHYY.js";let g=null,u=null;const k=async()=>{if(!(g&&u))try{const n=await l(()=>import("./index-BPHe3uFU.js").then(e=>e.T),__vite__mapDeps([0,1,2,3]));n.mapNodeToLevel&&(g=n.mapNodeToLevel),n.NODE_TO_LEVEL_MAPPING&&(u=n.NODE_TO_LEVEL_MAPPING)}catch(n){console.warn("Could not import mapping from TodoStore:",n)}},b=async n=>{if(!n)return null;if(await k(),g)return g(n);const e=n.replace(/[âœ…ğŸ”„â¸ï¸ğŸš«ğŸš€ğŸŒğŸ”ğŸ›ï¸âš™ï¸ğŸ’°ğŸ‘¤ğŸ“§ğŸ«â›“ï¸ğŸ’³ğŸ’¾]/g,"").replace(/<br\s*\/?>/gi," ").trim();if(u&&u[e])return u[e];const o=e.toLowerCase();if(u){for(const[t,i]of Object.entries(u))if(t.toLowerCase()===o)return i}return null},T=async(n,e)=>{const o=[],t=new Set;if(!n)return o;const i=[/(\w+)\[["']?([^"'\]]+)["']?\]/g,/(\w+)\[\(([^)]+)\)\]/g];for(const d of i){let s;for(;(s=d.exec(n))!==null;){const a=s[1];let r=s[2]||s[3]||"";if(t.has(a)||(t.add(a),r=r.replace(/<br\s*\/?>/gi," ").trim(),!r||r.match(/^flowchart[_-]/i)))continue;let c=await b(r||a);if(c||(c=await b(a)),!c){const h=(r||a).toLowerCase(),v={admin:"Level13_AdminRBAC",customer:"Level3_CustomerIdentity",order:"Level7_TradingEngine",trade:"Level7_TradingEngine",wallet:"Level5_WalletServices",payment:"Level11_PaymentGateways",blockchain:"Level6_Blockchain",market:"Level8_MarketManagement",coin:"Level8_MarketManagement",email:"Level4_Notifications",sms:"Level4_Notifications",notification:"Level4_Notifications",ticket:"Level15_SupportContent",database:"Level2_DatabaseAuth",security:"Level2_DatabaseAuth",auth:"Level2_DatabaseAuth"};for(const[P,L]of Object.entries(v))if(h.includes(P)){c=L;break}}c||(c="Level1_ProjectSetup",console.warn(`âš ï¸ Node "${r||a}" could not be mapped, using Level1 as fallback`));const m=C(a,r),p=A(a,m),w=r.split(/\n|<br\s*\/?>/).filter(h=>h.trim()),N=Math.max(...w.map(h=>h.length),10),E=w.length||1;let f=Math.max(180,N*7+40),_=Math.max(90,E*24+50);switch(m){case"high":f*=1.5,_*=1.5;break;case"medium":f*=1.2,_*=1.2;break}o.push({nodeId:a,label:r,type:O(r||a),description:null,position:p,style:{width:f,height:_},metadata:{originalLabel:r,extractedFrom:"mermaid",diagramId:e,importance:m},diagramId:e,taskNodeId:c})}}return console.log(`ğŸ“Š Extracted ${o.length} nodes from diagram ${e}, ${o.filter(d=>d.taskNodeId).length} mapped to Level tasks`),o},O=n=>{const e=n.toLowerCase();return e.includes("controller")||e.includes("api")?"controller":e.includes("service")?"service":e.includes("database")||e.includes("db")||e.includes("table")?"database":e.includes("wallet")?"wallet":e.includes("blockchain")||e.includes("crypto")?"blockchain":e.includes("payment")||e.includes("gateway")?"payment":e.includes("client")||e.includes("user")?"client":e.includes("security")||e.includes("auth")?"security":"component"},C=(n,e)=>{const o=(n||"").toLowerCase(),t=(e||"").toLowerCase();return o.includes("controllers")||o.includes("services")||o.includes("database")||o.includes("everything")||o.includes("advanced")||o.includes("missing")||t.includes("controllers")||t.includes("services")||t.includes("database")||t.includes("everything")||t.includes("advanced")||t.includes("missing")?"high":o.includes("order")||o.includes("trade")||o.includes("wallet")||o.includes("customer")||o.includes("payment")||o.includes("blockchain")||o.includes("security")||o.includes("auth")?"medium":"low"},A=(n,e)=>{let i=0;for(let r=0;r<n.length;r++)i=(i<<5)-i+n.charCodeAt(r),i=i&i;const d=e==="high"?400:e==="medium"?300:250,s=100+Math.abs(i)%10*d,a=100+Math.floor(Math.abs(i)/10)%10*d;return{x:s,y:a}},I=n=>{const e=[],o=new Set,t=/(\w+)\s*(?:-->|-.->|---)\s*(?:\|([^|]+)\|)?\s*(\w+)/g;let i;for(;(i=t.exec(n))!==null;){const d=i[1],s=i[3],a=i[2]||null,r=i[0].includes("-.->")?"dashed":"directed",c=`${d}-->${s}`;o.has(c)||(o.add(c),e.push({source:d,target:s,label:a,type:r,metadata:{extractedFrom:"mermaid",originalEdge:i[0]}}))}return e},D=async(n,e)=>{var o;try{const{API_ENDPOINTS:t}=await l(async()=>{const{API_ENDPOINTS:s}=await import("./index-BPHe3uFU.js").then(a=>a.a);return{API_ENDPOINTS:s}},__vite__mapDeps([0,1,2,3])),i=e.edges||I(e.code||e.mermaidCode||""),d=await fetch(t.diagramByDiagramId(n),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e.title,description:e.description,mermaidCode:e.code||e.mermaidCode,customMermaidCode:e.customMermaidCode,nodes:e.nodes,edges:i,metadata:{...e.metadata,edgesCount:i.length,nodesCount:((o=e.nodes)==null?void 0:o.length)||0}})});if(!d.ok)throw new Error("Failed to save diagram");return await d.json()}catch(t){throw console.error("Failed to save diagram to backend:",t),t}},S=async(n,e)=>{try{const{API_ENDPOINTS:o}=await l(async()=>{const{API_ENDPOINTS:t}=await import("./index-BPHe3uFU.js").then(i=>i.a);return{API_ENDPOINTS:t}},__vite__mapDeps([0,1,2,3]));if(await fetch(`${o.nodesByDiagram(n)}`,{method:"DELETE"}).catch(()=>{}),e.length>0){const t=await fetch(o.bulkCreateNodes,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Failed to save nodes");return await t.json()}return[]}catch(o){throw console.error("Failed to save nodes to backend:",o),o}},j=async()=>{try{const{API_ENDPOINTS:n}=await l(async()=>{const{API_ENDPOINTS:s}=await import("./index-BPHe3uFU.js").then(a=>a.a);return{API_ENDPOINTS:s}},__vite__mapDeps([0,1,2,3])),e=Object.values(y).map(s=>({diagramId:s.id,title:s.title,description:s.description||s.subtitle||"",mermaidCode:s.code||"",customMermaidCode:null,nodes:null,edges:null,metadata:{type:s.type,icon:s.icon,children:s.children||[],parent:s.parent||null}}));console.log("ğŸŒ± Seeding diagrams to backend...");const o=await fetch(n.seedDiagrams,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error("Failed to seed diagrams");const t=await o.json();console.log(`âœ… Seeded ${t.created} diagrams, skipped ${t.skipped}`),console.log("ğŸŒ± Extracting and seeding nodes and edges...");let i=0,d=0;for(const s of Object.values(y)){const a=await T(s.code||"",s.id),r=I(s.code||""),c=await fetch(n.diagramByDiagramId(s.id));if(c.ok){const m=await c.json();a.forEach(p=>{p.diagramId=m.id}),a.length>0&&(await S(m.id,a),i+=a.length,console.log(`  âœ… Seeded ${a.length} nodes for diagram: ${s.id}`)),r.length>0&&(await D(s.id,{title:s.title,description:s.description||s.subtitle||"",code:s.code,mermaidCode:s.code,edges:r}),d+=r.length,console.log(`  âœ… Seeded ${r.length} edges for diagram: ${s.id}`))}}return console.log(`âœ… Total nodes seeded: ${i}, Total edges seeded: ${d}`),{diagrams:t,nodes:i,edges:d}}catch(n){throw console.error("Failed to seed diagrams and nodes:",n),n}},R=async n=>{try{const{API_ENDPOINTS:e}=await l(async()=>{const{API_ENDPOINTS:t}=await import("./index-BPHe3uFU.js").then(i=>i.a);return{API_ENDPOINTS:t}},__vite__mapDeps([0,1,2,3])),o=await fetch(e.diagramByDiagramId(n));return o.ok?(await o.json()).edges||[]:[]}catch(e){return console.error("Failed to load edges from backend:",e),[]}},x=async()=>{try{const{API_ENDPOINTS:n}=await l(async()=>{const{API_ENDPOINTS:o}=await import("./index-BPHe3uFU.js").then(t=>t.a);return{API_ENDPOINTS:o}},__vite__mapDeps([0,1,2,3])),e=await fetch(n.diagrams);return e.ok?(await e.json()).map(t=>{var i,d,s,a;return{id:t.diagramId,title:t.title,subtitle:t.description||"",icon:((i=t.metadata)==null?void 0:i.icon)||"ğŸ“Š",type:((d=t.metadata)==null?void 0:d.type)||"detail",description:t.description||"",code:t.mermaidCode||t.customMermaidCode||"",children:((s=t.metadata)==null?void 0:s.children)||[],parent:((a=t.metadata)==null?void 0:a.parent)||null,dbId:t.id,customMermaidCode:t.customMermaidCode,nodes:t.nodes,edges:t.edges,metadata:t.metadata}}):[]}catch(n){return console.error("Failed to load diagrams from backend:",n),[]}},B=async n=>{var e,o,t,i;try{const{API_ENDPOINTS:d}=await l(async()=>{const{API_ENDPOINTS:a}=await import("./index-BPHe3uFU.js").then(r=>r.a);return{API_ENDPOINTS:a}},__vite__mapDeps([0,1,2,3])),s=await fetch(d.diagramByDiagramId(n));if(s.ok){const a=await s.json(),r=a.customMermaidCode||a.mermaidCode||"";return!r||r.trim()===""?(console.log(`âš ï¸ Diagram ${n} in DB has no code, will use registry`),null):{id:a.diagramId,title:a.title,subtitle:a.description||"",icon:((e=a.metadata)==null?void 0:e.icon)||"ğŸ“Š",type:((o=a.metadata)==null?void 0:o.type)||"detail",description:a.description||"",code:r,children:((t=a.metadata)==null?void 0:t.children)||[],parent:((i=a.metadata)==null?void 0:i.parent)||null,dbId:a.id,customMermaidCode:a.customMermaidCode,mermaidCode:a.mermaidCode,nodes:a.nodes,edges:a.edges,metadata:a.metadata}}return null}catch(d){return console.error("Failed to load diagram from backend:",d),null}},V=async n=>{try{const{API_ENDPOINTS:e}=await l(async()=>{const{API_ENDPOINTS:t}=await import("./index-BPHe3uFU.js").then(i=>i.a);return{API_ENDPOINTS:t}},__vite__mapDeps([0,1,2,3]));let o=await fetch(`${e.nodes}?diagramId=${n}`);if(!o.ok){const t=await fetch(e.diagramByDiagramId(n));if(t.ok){const i=await t.json();o=await fetch(`${e.nodes}?diagramId=${i.id}`)}}return o.ok?await o.json():[]}catch(e){return console.error("Failed to load nodes from backend:",e),[]}};export{I as extractEdgesFromMermaid,T as extractNodesFromMermaid,x as loadAllDiagramsFromBackend,B as loadDiagramFromBackend,R as loadEdgesFromBackend,V as loadNodesFromBackend,D as saveDiagramToBackend,S as saveNodesToBackend,j as seedDiagramsAndNodes};
